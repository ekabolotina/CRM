var ajaxLoading = false;

function checkFormFields($form){
	var f = false;
	$form.find('.form-group').removeClass('has-error');
	$form.find('input:not([type=submit]), select, textarea').each(function(){
		var $this = $(this);
		if($this.is('[require]') && $this.val() == ''){
			f = true;
			$this.closest('.form-group').addClass('has-error');
		}
	});
	if(f) return false;
	return $form.serialize();	
}

function showMessage(text, ids = '', large = false){
	var $openedModal = $('.modalAutoGenerated'),
		openedModalLength = $openedModal.length
	if(openedModalLength){
		$openedModal.modal('hide').on('hidden.bs.modal', function(){
			$('body').addClass('modal-open');
		});;
	}
	var msg = '<div class="modal fade modalAutoGenerated" role="dialog"'+ ((ids) ? 'id='+ ids : '') +'><div class="modal-dialog'+ ((large) ? ' modal-lg' : '') +'" role="document"><div class="modal-content"><div class="modal-body">'+ text +'</div></div></div></div>';
	var mod = $(msg).modal().on('hidden.bs.modal', function(){
			$(this).remove();	
		});
	return mod;
}

function showAlert(form, text, type = 'danger'){
	$('.alert').remove();
	form.before('<div class="alert alert-'+ type +' fade in"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>'+ text +'</div>');
	$('html, body').animate({scrollTop: 0});
}

function loginUserCallbackAfter(data){
	data = JSON.parse(data);
	if(data.error == 200){
		showAlert($('#loginForm form'), 'Авторизация прошла успешно. Обновляем страницу.', 'success');	
		document.location.reload();
	}else
		showAlert($('#loginForm form'), 'Не верный логин или пароль.');	
}

$(document).ready(function(){

	$('.submit').click(function(){
		$(this).closest('form').submit();
	});

	$('.ajaxForm').submit(function(e){
		e.preventDefault();
		var $form = $(this),
			$submit = $form.find('.submit, [type=submit]');
			srz = checkFormFields($form),
			action = $form.attr('action'),
			callbackBefore = $form.attr('callback-before'),
			callbackAfter = $form.attr('callback-after'),
			callBackResult = (callbackBefore) ? window[callbackBefore]($form) : true;
		if(ajaxLoading || !srz || !action || !callBackResult) return;
		$submit.addClass('disabled');
		ajaxLoading = true;
		$.post(action, srz).fail(function(){
			console.log('Error');
		}).done(function(data){
			if(callbackAfter) window[callbackAfter](data);
		}).always(function(){
			ajaxLoading = false;
			$submit.removeClass('disabled');
		});
	});

	$('#logout').click(function(e){
		e.preventDefault();
		if(ajaxLoading) return;
		ajaxLoading = true;
		$.post('/logout/').always(function(){
			document.location.reload();
		});		
	});

});